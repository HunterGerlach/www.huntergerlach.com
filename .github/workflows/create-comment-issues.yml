name: Create Comment Issues

on:
  push:
    branches: [main]
    paths: ['_posts/**']

permissions:
  contents: write
  issues: write

jobs:
  create-comment-issues:
    runs-on: ubuntu-latest

    # Skip if the last commit was made by this workflow
    if: "!contains(github.event.head_commit.message, '[auto-comments]')"

    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Create issues for posts with comments_id auto
        env:
          GH_TOKEN: ${{ github.token }}
        run: |
          changed=false

          for file in _posts/*.md; do
            # Check if this file has comments_id: auto in its frontmatter
            if ! grep -q '^comments_id: auto$' "$file"; then
              continue
            fi

            # Extract the post title from frontmatter
            title=$(sed -n 's/^title: *//p' "$file" | head -1)
            if [ -z "$title" ]; then
              echo "WARNING: No title found in $file, skipping"
              continue
            fi

            # Derive the post URL from the filename
            # Filename format: YYYY-MM-DD-slug.md â†’ slug.html
            slug=$(basename "$file" .md | sed 's/^[0-9]\{4\}-[0-9]\{2\}-[0-9]\{2\}-//')
            post_url="https://www.huntergerlach.com/${slug}.html"

            # Create the GitHub Issue
            issue_url=$(gh issue create \
              --title "Comments: ${title}" \
              --body "Comment thread for [${title}](${post_url}).")
            issue_number=$(echo "$issue_url" | grep -o '[0-9]*$')

            if [ -z "$issue_number" ]; then
              echo "ERROR: Failed to create issue for $file, skipping"
              continue
            fi

            echo "Created issue #${issue_number} for: ${title}"

            # Replace 'auto' with the actual issue number
            sed -i "s/^comments_id: auto$/comments_id: ${issue_number}/" "$file"
            changed=true
          done

          if [ "$changed" = true ]; then
            git config user.name "github-actions[bot]"
            git config user.email "41898282+github-actions[bot]@users.noreply.github.com"
            git add _posts/
            git commit -m "Set comment issue IDs for new posts [auto-comments]"
            git push
          else
            echo "No posts with comments_id: auto found"
          fi
